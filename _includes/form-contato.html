{% assign form_id = include.src | default: 'form' %}
<form id="{{ form_id }}" class="needs-validation" novalidate data-popup="{{ include.src | default: false }}">
  <!-- Honeypot -->
  <div class="d-none">
    <input type="text" name="{{ form_id }}-website" id="{{ form_id }}-website">
  </div>

  <!-- Campos de Referência -->
  <div class="d-none">
    <input type="hidden" name="{{ form_id }}-ref_title" id="{{ form_id }}-ref_title" value="{% if include.src %}Solicitação de Apresentação{% else %}{% if page.ref %}{{ page.ref }}{% else %}{{ page.title }}{% endif %}{% endif %}">
    <input type="hidden" name="{{ form_id }}-ref_url" id="{{ form_id }}-ref_url" value="{{ site.url }}{{ site.baseurl }}{{ page.url }}">
    {% if include.src %}
    <input type="hidden" name="{{ form_id }}-assunto" id="{{ form_id }}-assunto" value="apresentacao">
    {% endif %}
  </div>

  <div class="row g-3">
    <!-- Nome -->
    <div class="col-md-12">
      <label for="{{ form_id }}-nome" class="form-label visually-hidden">Nome Completo</label>
      <input type="text" class="form-control" id="{{ form_id }}-nome" name="{{ form_id }}-nome" placeholder="Nome Completo" required>
    </div>

    <!-- Email -->
    <div class="col-md-6">
      <label for="{{ form_id }}-email" class="form-label visually-hidden">E-mail</label>
      <input type="email" class="form-control" id="{{ form_id }}-email" name="{{ form_id }}-email" placeholder="E-mail" required>
    </div>

    <!-- Telefone -->
    <div class="col-md-6">
      <label for="{{ form_id }}-telefone" class="form-label visually-hidden">Telefone</label>
      <input type="tel" class="form-control fone-br" id="{{ form_id }}-telefone" name="{{ form_id }}-telefone" placeholder="Telefone" required>
    </div>

    <!-- Assunto (apenas visível fora da popup) -->
    {% unless include.src %}
    <div class="col-md-6">
      <label for="{{ form_id }}-assunto" class="form-label visually-hidden">Assunto</label>
      <select class="form-control" id="{{ form_id }}-assunto" name="{{ form_id }}-assunto" required>
        <option value="" selected disabled>Selecione um assunto</option>
        {% for assunto in site.data.global.contato.assuntos %}
        <option value="{{ assunto.value }}" data-email="{{ assunto.email }}">{{ assunto.texto }}</option>
        {% endfor %}
      </select>
    </div>
    {% endunless %}

    <!-- Mensagem -->
    <div class="col-12">
      <label for="{{ form_id }}-mensagem" class="form-label visually-hidden">Mensagem</label>
      <textarea class="form-control" id="{{ form_id }}-mensagem" name="{{ form_id }}-mensagem" placeholder="Mensagem" rows="4" required></textarea>
    </div>

    <!-- Aceite -->
    <div class="col-12">
      <div class="form-check text-balanced">
        <input class="form-check-input" type="checkbox" id="{{ form_id }}-aceite" name="{{ form_id }}-aceite" required>
        <label class="form-check-label small fst-italic cursor-pointer" for="{{ form_id }}-aceite">
          Aceito fornecer meus dados para que a ConsigLog possa retornar meu contato.
        </label>
      </div>
    </div>

    <!-- Botão Enviar -->
    <div class="col-12 mt-4">
      <button type="submit" class="btn btn-primary btn-lg" id="{{ form_id }}-submit" disabled>
        <span class="material-symbols-rounded me-2">send</span>
        Enviar Mensagem
      </button>
    </div>
  </div>
</form>

<!-- Alertas -->
<div id="{{ form_id }}-success" class="alert alert-success alert-dismissible fade show mt-3" role="alert" style="display: none;">
  Formulário enviado com sucesso!
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div id="{{ form_id }}-error" class="alert alert-danger alert-dismissible fade show mt-3" role="alert" style="display: none;">
  Ocorreu um erro ao enviar o formulário. Tente novamente.
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<script>
(function() {
  // Configurações do FormEasy e variáveis do template
  const CONFIG = {
    url: "{{ site.data.global.formeasy.url }}",
    isPopup: "{{ include.src }}" !== "",
    apresentacaoEmail: "{{ site.data.global.contato.assuntos | where: 'value', 'apresentacao' | map: 'email' | first }}"
  };

  document.addEventListener('DOMContentLoaded', () => {
    const formId = '{{ form_id }}';
    const form = document.getElementById(formId);
    const submitButton = document.getElementById(`${formId}-submit`);
    const aceiteCheckbox = document.getElementById(`${formId}-aceite`);
    const successAlert = document.getElementById(`${formId}-success`);
    const errorAlert = document.getElementById(`${formId}-error`);

    // Obtém parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('ref');
    
    // Atualiza o campo ref_title se houver parâmetro ref na URL
    if (refParam) {
      document.getElementById(`${formId}-ref_title`).value = refParam;
    }

    // Habilita/desabilita o botão baseado no checkbox
    aceiteCheckbox.addEventListener('change', () => {
      submitButton.disabled = !aceiteCheckbox.checked;
    });

    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        if (form.querySelector(`#${formId}-website`).value) {
          return;
        }

        if (!form.checkValidity()) {
          event.stopPropagation();
          form.classList.add('was-validated');
          return;
        }

        submitButton.innerHTML = `
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Enviando...
        `;
        submitButton.disabled = true;

        try {
          const formData = {
            name: form.querySelector(`#${formId}-nome`).value,
            email: form.querySelector(`#${formId}-email`).value,
            phone: form.querySelector(`#${formId}-telefone`).value,
            message: form.querySelector(`#${formId}-mensagem`).value,
            subject: CONFIG.isPopup ? 'apresentacao' : form.querySelector(`#${formId}-assunto`).value,
            destination: CONFIG.isPopup ? CONFIG.apresentacaoEmail : form.querySelector(`#${formId}-assunto`).options[form.querySelector(`#${formId}-assunto`).selectedIndex].dataset.email,
            ref_title: form.querySelector(`#${formId}-ref_title`).value,
            ref_url: form.querySelector(`#${formId}-ref_url`).value
          };

          const response = await fetch(CONFIG.url, {
            method: "POST",
            headers: {
              "Content-Type": "text/plain;charset=utf-8"
            },
            // mode: 'no-cors',
            body: JSON.stringify(formData)
          });

          const data = await response.json();
          console.log("Resposta do servidor:", data);

          form.reset();
          successAlert.style.display = "block";
          
          if (form.dataset.popup !== 'false') {
            document.getElementById('popup-apresentacao').querySelector('.btn-close').click();
          }
        } catch (error) {
          console.error('Erro:', error);
          errorAlert.style.display = "block";
        } finally {
          submitButton.innerHTML = `
            <span class="material-symbols-rounded me-2">send</span>
            Enviar Mensagem
          `;
          submitButton.disabled = !aceiteCheckbox.checked;
        }
      });
    }
  });
})();
</script> 